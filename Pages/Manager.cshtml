@page
@model ManagerModel
@{
    ViewData["Title"] = "Manager Dashboard";
}

<style>
    /* Previous styles remain the same... */
    .dashboard-header {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        padding: 30px;
        border-radius: 10px;
        margin-bottom: 30px;
    }

    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
    }

    .stat-card {
        background: white;
        padding: 25px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: center;
    }

    .stat-value {
        font-size: 2.5rem;
        font-weight: 700;
        color: #3498db;
        margin-bottom: 5px;
    }

    .stat-label {
        color: #7f8c8d;
        font-size: 0.9rem;
    }

    .section-card {
        background: white;
        padding: 30px;
        border-radius: 10px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 30px;
    }

    .btn-primary-custom {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        border: none;
        padding: 12px 30px;
        border-radius: 25px;
        color: white;
        font-weight: 600;
        transition: opacity 0.3s;
    }

        .btn-primary-custom:hover {
            opacity: 0.9;
        }

    .car-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 25px;
        margin-top: 20px;
    }

    .car-card {
        border: 1px solid #e0e0e0;
        border-radius: 10px;
        overflow: hidden;
        transition: transform 0.3s, box-shadow 0.3s;
    }

        .car-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }

    .car-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        background: #f0f0f0;
    }

    .car-info {
        padding: 20px;
    }

    .car-title {
        font-size: 1.3rem;
        font-weight: 600;
        margin-bottom: 10px;
        color: #2c3e50;
    }

    .car-price {
        font-size: 1.5rem;
        color: #27ae60;
        font-weight: 700;
        margin: 10px 0;
    }

    .car-specs {
        color: #7f8c8d;
        font-size: 0.9rem;
        margin: 10px 0;
    }

    .badge-available {
        background: #2ecc71;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    .badge-rented {
        background: #e74c3c;
        color: white;
        padding: 5px 15px;
        border-radius: 20px;
        font-size: 0.85rem;
    }

    .pending-payments {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        padding: 15px;
        margin-bottom: 15px;
        border-radius: 5px;
    }

    .payment-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px;
        background: white;
        border-radius: 8px;
        margin-bottom: 10px;
        border: 1px solid #e0e0e0;
        transition: all 0.3s;
    }

        .payment-item.processing {
            opacity: 0.6;
            pointer-events: none;
        }

    .btn-approve {
        background: #2ecc71;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        transition: background 0.3s;
    }

        .btn-approve:hover {
            background: #27ae60;
        }

    .btn-reject {
        background: #e74c3c;
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 20px;
        cursor: pointer;
        margin-left: 10px;
        transition: background 0.3s;
    }

        .btn-reject:hover {
            background: #c0392b;
        }

    .payment-type-badge {
        display: inline-block;
        padding: 3px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 8px;
    }

    .badge-deposit {
        background: #3498db;
        color: white;
    }

    .badge-full {
        background: #2ecc71;
        color: white;
    }

    /* Modal and other styles remain the same... */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.5);
    }

    .modal-content {
        background: white;
        margin: 50px auto;
        padding: 30px;
        border-radius: 10px;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .close {
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        color: #aaa;
    }

        .close:hover {
            color: #000;
        }

    .form-group {
        margin-bottom: 20px;
    }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #2c3e50;
        }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 5px;
        font-size: 1rem;
    }

    textarea.form-control {
        resize: vertical;
        min-height: 100px;
    }
</style>

<div class="dashboard-header">
    <h1>Manager Dashboard</h1>
    <p>Manage your fleet and approve bookings</p>
</div>

<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-value">@Model.TotalCars</div>
        <div class="stat-label">Total Cars</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">@Model.AvailableCars</div>
        <div class="stat-label">Available</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">@Model.PendingBookings</div>
        <div class="stat-label">Pending Bookings</div>
    </div>
    <div class="stat-card">
        <div class="stat-value">@Model.PendingPayments</div>
        <div class="stat-label">Pending Payments</div>
    </div>
</div>

<!-- Pending Payments Section -->
@if (Model.PendingPayments > 0)
{
    <div class="section-card">
        <h3>⚠️ Pending Payment Approvals</h3>
        <div style="margin-top: 20px;" id="paymentsContainer">
            @foreach (var payment in Model.PendingPaymentsList)
            {
                <div class="payment-item" id="payment-@payment.Id">
                    <div>
                        <strong>@payment.ClientName</strong>
                        <span class="payment-type-badge badge-@(payment.PaymentType.ToLower())">
                            @payment.PaymentType Payment
                        </span>
                        <div style="font-size: 0.9rem; color: #7f8c8d;">
                            Code: @payment.PaymentCode | Amount: @payment.Amount.ToString("N0") RWF
                        </div>
                        <div style="font-size: 0.85rem; color: #95a5a6; margin-top: 3px;">
                            Email: @payment.ClientEmail
                        </div>
                    </div>
                    <div>
                        <button class="btn-approve" onclick="approvePayment(@payment.Id)">
                            ✓ Approve
                        </button>
                        <button class="btn-reject" onclick="rejectPayment(@payment.Id)">
                            ✕ Reject
                        </button>
                    </div>
                </div>
            }
        </div>
    </div>
}

<!-- Car Management Section -->
<div class="section-card">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3>Fleet Management</h3>
        <button class="btn-primary-custom" onclick="openAddCarModal()">
            + Add New Car
        </button>
    </div>

    <div class="car-grid">
        @foreach (var car in Model.Cars)
        {
            <div class="car-card">
                <img src="@(string.IsNullOrEmpty(car.ImageUrl) ? "/images/car-placeholder.jpg" : car.ImageUrl)"
                     alt="@car.Brand @car.Model"
                     class="car-image">
                <div class="car-info">
                    <div class="car-title">@car.Brand @car.Model</div>
                    <div class="car-specs">
                        Year: @car.Year | Color: @car.Color<br />
                        Plate: @car.PlateNumber
                    </div>
                    <div class="car-price">@car.DailyRateRWF.ToString("N0") RWF/day</div>
                    <div style="margin: 10px 0;">
                        @if (car.IsAvailable)
                        {
                            <span class="badge-available">Available</span>
                        }
                        else
                        {
                            <span class="badge-rented">Rented</span>
                        }
                    </div>
                    <div style="margin-top: 15px;">
                        <button class="btn btn-sm btn-outline-primary" onclick="editCar(@car.Id)">Edit</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteCar(@car.Id)">Delete</button>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

<!-- System Health Section -->
<div class="section-card">
    <h3>System Health Monitoring</h3>
    <div class="system-health" style="margin-top: 20px; display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;">CPU Usage</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">@Model.CpuUsage%</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;">Memory Usage</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">@Model.MemoryUsage%</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;">Active Users</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">@Model.ActiveUsers</div>
        </div>
        <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; border-left: 4px solid #3498db;">
            <div style="font-size: 0.85rem; color: #7f8c8d; margin-bottom: 5px;">Uptime</div>
            <div style="font-size: 1.5rem; font-weight: 600; color: #2c3e50;">@Model.SystemUptime</div>
        </div>
    </div>
</div>

<!-- Add Car Modal -->
<div id="addCarModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeAddCarModal()">&times;</span>
        <h2>Add New Car</h2>
        <form method="post" asp-page-handler="AddCar" enctype="multipart/form-data">
            <div class="form-group">
                <label>Brand</label>
                <input type="text" name="Brand" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Model</label>
                <input type="text" name="Model" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Year</label>
                <input type="number" name="Year" class="form-control" min="2000" max="2025" required>
            </div>
            <div class="form-group">
                <label>Color</label>
                <input type="text" name="Color" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Plate Number</label>
                <input type="text" name="PlateNumber" class="form-control" required>
            </div>
            <div class="form-group">
                <label>Specifications</label>
                <textarea name="Specifications" class="form-control" required></textarea>
            </div>
            <div class="form-group">
                <label>Daily Rate (RWF)</label>
                <input type="number" name="DailyRateRWF" class="form-control" step="0.01" required>
            </div>
            <div class="form-group">
                <label>Car Image</label>
                <input type="file" name="ImageFile" class="form-control" accept="image/*">
            </div>
            <button type="submit" class="btn-primary-custom" style="width: 100%;">Add Car</button>
        </form>
    </div>
</div>

<script>
    function openAddCarModal() {
        document.getElementById('addCarModal').style.display = 'block';
    }

    function closeAddCarModal() {
        document.getElementById('addCarModal').style.display = 'none';
    }

    async function approvePayment(paymentId) {
        const paymentItem = document.getElementById(`payment-${paymentId}`);
        paymentItem.classList.add('processing');

        try {
            const response = await fetch(`/Manager?handler=ApprovePayment&paymentId=${paymentId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            if (response.ok) {
                // Remove the payment item with animation
                paymentItem.style.transition = 'all 0.3s';
                paymentItem.style.opacity = '0';
                paymentItem.style.transform = 'translateX(100px)';

                setTimeout(() => {
                    paymentItem.remove();

                    // Check if no more payments
                    const remaining = document.querySelectorAll('.payment-item').length;
                    if (remaining === 0) {
                        location.reload();
                    }
                }, 300);
            }
        } catch (error) {
            console.error('Error:', error);
            paymentItem.classList.remove('processing');
            alert('Failed to approve payment. Please try again.');
        }
    }

    async function rejectPayment(paymentId) {
        const paymentItem = document.getElementById(`payment-${paymentId}`);
        paymentItem.classList.add('processing');

        try {
            const response = await fetch(`/Manager?handler=RejectPayment&paymentId=${paymentId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            });

            if (response.ok) {
                // Remove the payment item with animation
                paymentItem.style.transition = 'all 0.3s';
                paymentItem.style.opacity = '0';
                paymentItem.style.transform = 'translateX(-100px)';

                setTimeout(() => {
                    paymentItem.remove();

                    // Check if no more payments
                    const remaining = document.querySelectorAll('.payment-item').length;
                    if (remaining === 0) {
                        location.reload();
                    }
                }, 300);
            }
        } catch (error) {
            console.error('Error:', error);
            paymentItem.classList.remove('processing');
            alert('Failed to reject payment. Please try again.');
        }
    }

    function editCar(carId) {
        window.location.href = `/Manager/EditCar?id=${carId}`;
    }

    function deleteCar(carId) {
        if(confirm('Are you sure you want to delete this car?')) {
            fetch(`/Manager?handler=DeleteCar&carId=${carId}`, {
                method: 'POST',
                headers: {
                    'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]').value
                }
            }).then(() => location.reload());
        }
    }

    window.onclick = function(event) {
        var modal = document.getElementById('addCarModal');
        if (event.target == modal) {
            modal.style.display = "none";
        }
    }
</script>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
}